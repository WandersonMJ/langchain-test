================================================================================
  GUIA DE IMPLEMENTA√á√ÉO: SOLU√á√ïES PARA CONTEXTO E VERBOSIDADE
================================================================================

√çNDICE:
1. SOLU√á√ÉO PROGRESSIVA (Recomendada)
2. SOLU√á√ÉO COM CACHE DE TOOLS (Sua ideia)
3. Compara√ß√£o e Recomenda√ß√µes

================================================================================
                        SOLU√á√ÉO 1: PROGRESSIVA
================================================================================

OBJETIVO: Reduzir verbosidade e adicionar contexto de sess√£o de forma simples

--------------------------------------------------------------------------------
FASE 1: AJUSTAR PROMPT (5 minutos)
--------------------------------------------------------------------------------

ARQUIVO: src/services/LangChainChatService.ts

O QUE FAZER:
- Adicionar regras de formata√ß√£o no system prompt
- Instruir a IA a ser concisa

COMO FAZER:
1. Localize o system prompt (string dentro de SystemMessage)
2. Adicione ANTES das "REGRAS DE OURO":

```
üé® REGRAS DE FORMATA√á√ÉO DE RESPOSTA:

1. Seja EXTREMAMENTE CONCISO
2. Ao listar profissionais, retorne APENAS nome e especialidade:
   ‚úÖ "Carlos Silva (Barbeiro), Maria Santos (Esteticista)"
   ‚ùå N√ÉO inclua: bio, foto, experi√™ncia, avalia√ß√£o

3. Ao listar servi√ßos, retorne APENAS nome e pre√ßo:
   ‚úÖ "Corte Masculino (R$ 45), Barba (R$ 30)"
   ‚ùå N√ÉO inclua: descri√ß√£o, dura√ß√£o

4. Use bullet points SOMENTE quando listar 5+ itens

5. Se o usu√°rio pedir "detalhes" ou "mais informa√ß√µes", A√ç SIM retorne tudo

EXEMPLO BOM:
Pergunta: "Quem trabalha hoje?"
Resposta: "Temos Carlos (Barbeiro), Maria (Esteticista), Ana (Massoterapeuta), 
Juliana (Cabeleireira) e Roberto (Barbeiro)."

EXEMPLO RUIM:
Resposta: "1. **Carlos Silva** (Barbearia)
   - Experi√™ncia: 8 anos
   - Avalia√ß√£o: 4.9..."
```

RESULTADO ESPERADO:
- Respostas 60-70% menores
- Mais naturais e conversacionais

TESTE:
curl -X POST http://localhost:3000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "Quem trabalha hoje?"}'

DEVE RETORNAR algo como:
"Temos Carlos (Barbeiro), Maria (Esteticista), Ana (Massoterapeuta), 
Juliana (Cabeleireira) e Roberto (Barbeiro)."

--------------------------------------------------------------------------------
FASE 2: SESSION MANAGER (30-45 minutos)
--------------------------------------------------------------------------------

OBJETIVO: Manter contexto entre mensagens de um mesmo usu√°rio

PASSO 1: CRIAR SESSION MANAGER
-------------------------------

ARQUIVO NOVO: src/services/SessionManager.ts

ESTRUTURA:
```typescript
interface SessionContext {
  sessionId: string;
  lastQuery: string;
  lastProfessionals: any[];
  lastServices: any[];
  conversationHistory: Array<{
    role: 'user' | 'assistant';
    content: string;
    timestamp: Date;
  }>;
  createdAt: Date;
  lastAccess: Date;
}

class SessionManager {
  - sessions: Map<string, SessionContext>
  - SESSION_TIMEOUT: 30 minutos
  
  M√âTODOS:
  + getOrCreateSession(sessionId): SessionContext
  + updateSession(sessionId, data): void
  + addMessage(sessionId, role, content): void
  + getSessionContext(sessionId): string
  + cleanExpiredSessions(): void
}
```

O QUE IMPLEMENTAR:

1. getOrCreateSession():
   - Verifica se sess√£o existe no Map
   - Se n√£o existe, cria nova com estrutura vazia
   - Atualiza lastAccess
   - Retorna sess√£o

2. addMessage():
   - Adiciona mensagem ao conversationHistory
   - Limita hist√≥rico a √∫ltimas 10 mensagens (slice(-10))
   - Serve para a IA ter contexto

3. getSessionContext():
   - Formata hist√≥rico como string
   - Formato: "Usu√°rio: ...\nVoc√™: ...\n"
   - Retorna string para incluir no prompt

4. cleanExpiredSessions():
   - Percorre todas as sess√µes
   - Remove as que lastAccess > 30 minutos
   - Chamar com setInterval a cada 5 minutos

5. Exportar singleton:
   export const sessionManager = new SessionManager();

PASSO 2: MODIFICAR CONTROLLER
------------------------------

ARQUIVO: src/controllers/ChatController.ts

O QUE FAZER:
1. Instalar uuid: npm install uuid @types/uuid
2. Importar: import { v4 as uuidv4 } from 'uuid';

3. No m√©todo sendMessage():
   
   ANTES DE PROCESSAR:
   - Pegar sessionId do header: req.headers['x-session-id']
   - Se n√£o existir, criar novo: uuidv4()
   
   PASSAR PARA O SERVICE:
   - const response = await this.chatService.processMessage(message, sessionId);
   
   RETORNAR NO JSON:
   - res.json({ message: response, sessionId })

PASSO 3: ATUALIZAR INTERFACE
-----------------------------

ARQUIVO: src/interfaces/IChatService.ts

MODIFICAR:
processMessage(message: string): Promise<string>;

PARA:
processMessage(message: string, sessionId?: string): Promise<string>;

PASSO 4: INTEGRAR NO SERVICE
-----------------------------

ARQUIVO: src/services/LangChainChatService.ts

O QUE FAZER:

1. Importar: import { sessionManager } from './SessionManager';

2. No in√≠cio do m√©todo processMessage(message, sessionId):
   
   ADICIONAR CONTEXTO:
   ```typescript
   let sessionContext = '';
   if (sessionId) {
     // Salva mensagem do usu√°rio
     sessionManager.addMessage(sessionId, 'user', message);
     
     // Pega hist√≥rico formatado
     sessionContext = sessionManager.getSessionContext(sessionId);
   }
   ```

3. No system prompt, ADICIONAR depois do contexto temporal:
   ```
   ${sessionContext}
   
   üí° Use o hist√≥rico acima para entender o contexto da conversa.
   Se o usu√°rio disser "e ele?" ou "esse profissional", consulte o hist√≥rico.
   ```

4. ANTES DE RETORNAR a resposta final:
   ```typescript
   if (sessionId) {
     sessionManager.addMessage(sessionId, 'assistant', contentStr);
   }
   ```

PASSO 5: TESTAR SESSION
------------------------

TESTE 1 - Sem sessionId (gera novo):
curl -X POST http://localhost:3000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "Quem trabalha hoje?"}'

COPIAR o sessionId retornado

TESTE 2 - Com sessionId (usa contexto):
curl -X POST http://localhost:3000/chat \
  -H "Content-Type: application/json" \
  -H "x-session-id: COLE_O_SESSION_ID_AQUI" \
  -d '{"message": "E o Carlos est√° livre amanh√£?"}'

RESULTADO ESPERADO:
- A IA deve entender que "Carlos" foi mencionado antes
- Deve usar contexto para responder

--------------------------------------------------------------------------------
FASE 3: MELHORIAS OPCIONAIS
--------------------------------------------------------------------------------

1. PERSISTIR SESS√ïES (Redis):
   - Instalar: npm install redis @langchain/redis
   - Trocar Map por RedisClient
   - Vantagem: Sobrevive a restart do servidor

2. LIMITAR HIST√ìRICO POR TOKENS:
   - Calcular tokens do hist√≥rico
   - Se > 1000 tokens, resumir com LLM

3. DASHBOARD DE SESS√ïES:
   - Endpoint GET /sessions
   - Mostra sess√µes ativas